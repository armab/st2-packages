machine:
  environment:
    DISTRO_0: debian
    DISTRO_1: ubuntu
    DISTRO_2: centos7
# update Docker manually
  pre:
    - sudo cp /home/ubuntu/.ssh/config /root/.ssh/config
    - sudo curl -L -o /usr/bin/docker 'http://s3-external-1.amazonaws.com/circle-downloads/docker-1.8.3-circleci'
    - sudo chmod 0755 /usr/bin/docker
    - sudo service docker start
#  services:
#    - docker

dependencies:
  cache_directories:
    - ~/docker
  pre:
    - mkdir -p ~/docker
  override:
    - sudo -H pip install --upgrade pip
    - sudo -H pip install docker-compose
    - docker-compose version
    #- if [[ -e ~/docker/postgres.tar ]]; then docker load -i ~/docker/postgres.tar; fi
    #- if [[ -e ~/docker/mongo.tar ]]; then docker load -i ~/docker/mongo.tar; fi
    #- if [[ -e ~/docker/rabbitmq:management.tar ]]; then docker load -i ~/docker/rabbitmq:management.tar; fi
    - sudo service docker stop && sudo cp -Ra ~/docker/. /var/lib/docker/ && sudo service docker start
    - docker-compose pull ${DISTRO_0}
    #- docker save postgres > ~/docker/postgres.tar
    #- docker save mongo > ~/docker/mongo.tar
    #- docker save rabbitmq:management > ~/docker/rabbitmq:management.tar
    - sudo service docker stop && sudo cp -Ra /var/lib/docker/. ~/docker/ && sudo service docker start
    - exit 1

database:
  override:
    - sudo service postgresql stop
    - sudo service rabbitmq-server stop
    - sudo service mongodb stop

test:
  override:
    - docker-compose up ${DISTRO_0}
  post:
    - mkdir ${CIRCLE_ARTIFACTS}/${DISTRO_0}
    - cp -R /tmp/st2-packages/tmp.*/* ${CIRCLE_ARTIFACTS}/${DISTRO_0}
